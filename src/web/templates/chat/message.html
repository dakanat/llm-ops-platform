{% if conversation_id is defined and conversation_id %}
<script>
  (function() {
    var el = document.getElementById("conversation-id");
    if (el) { el.value = "{{ conversation_id }}"; }
    _lastConversationId = "{{ conversation_id }}";
  })();
</script>
{% endif %}
<div class="chat chat-end">
  <div class="chat-bubble chat-bubble-primary">{{ user_message }}</div>
</div>
<div class="chat chat-start">
  <div class="chat-bubble">{{ assistant_message }}</div>
  <div class="chat-footer opacity-50 text-xs">{{ model }}</div>
</div>

{% if stopped_by_max_steps is defined and stopped_by_max_steps %}
<div class="alert alert-warning mt-2">
  <span>Agent reached maximum steps ({{ total_steps }})</span>
</div>
{% endif %}

{% if steps is defined and steps %}
{% set tool_steps = steps | selectattr("action") | list %}
{% if tool_steps %}
<div class="mt-2">
  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox" />
    <div class="collapse-title font-medium text-sm">
      Steps ({{ total_steps }})
    </div>
    <div class="collapse-content space-y-2">
      {% for step in steps %}
      <div class="{% if step.is_error %}border border-error rounded-lg p-2{% endif %}">
        <div class="text-sm">
          {% if step.action %}
          <span class="badge badge-primary badge-sm">{{ step.action }}</span>
          {% else %}
          <span class="badge badge-ghost badge-sm">Thinking</span>
          {% endif %}
        </div>
        <p class="text-xs opacity-70 mt-1">{{ step.thought }}</p>
        {% if step.action %}
        <div class="text-xs mt-1">
          <code>{{ step.action }}({{ step.action_input }})</code>
        </div>
        {% endif %}
        {% if step.observation %}
        <p class="text-xs whitespace-pre-wrap mt-1 {% if step.is_error %}text-error{% endif %}">{{ step.observation }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
{% endif %}

{% if sources is defined and sources %}
<div class="mt-2">
  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox" />
    <div class="collapse-title font-medium text-sm">
      Sources ({{ sources | length }})
    </div>
    <div class="collapse-content space-y-1">
      {% for source in sources %}
      <div class="collapse collapse-arrow bg-base-100 border border-base-300 rounded">
        <input type="checkbox" />
        <div class="collapse-title text-xs py-1 min-h-0">
          <span class="badge badge-outline badge-sm">Chunk #{{ source.chunk_index }}</span>
          <a href="/web/rag/documents/{{ source.document_id }}"
             target="_blank" hx-boost="false"
             class="link link-hover text-xs opacity-50 ml-2 relative z-10">{{ source.document_id[:8] }}...</a>
        </div>
        <div class="collapse-content">
          <p class="text-xs whitespace-pre-wrap">{{ source.content }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
